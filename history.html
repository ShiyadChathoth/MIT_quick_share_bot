<script>
    const historyContainer = document.getElementById('history-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const noFilesMessage = document.getElementById('no-files-message');
    let serverUrl = '';

    const fetchFileHistory = async () => {
        if (!serverUrl) {
            alert('Webhook URL is not set. Please save your full webhook URL in the main page settings.');
            return;
        }

        historyContainer.innerHTML = '';
        noFilesMessage.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        try {
            // The server URL is like 'https://.../webhook', we need to remove '/webhook'
            const baseUrl = serverUrl.replace('/webhook', '');
            const response = await fetch(`${baseUrl}/history`);

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            const files = await response.json();

            if (files.length === 0) {
                noFilesMessage.classList.remove('hidden');
            } else {
                displayFiles(files, baseUrl);
            }
        } catch (error) {
            console.error(error);
            alert(`Failed to fetch history. Check console for details.`);
            noFilesMessage.classList.remove('hidden');
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    };

    const displayFiles = (files, baseUrl) => {
        for (const file of files) {
            const fileElement = document.createElement('div');
            fileElement.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg';

            const downloadUrl = `${baseUrl}/download/${file.id}`;

            fileElement.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800 dark:text-gray-200">${file.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Created: ${new Date(file.createdTime).toLocaleString()}</p>
                </div>
                <div class="flex items-center gap-2">
                    <a href="${downloadUrl}" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 text-xs font-medium text-white bg-indigo-500 rounded-md hover:bg-indigo-600">
                        Download
                    </a>
                    <button onclick="deleteFile('${file.id}')" class="px-3 py-1.5 text-xs font-medium text-white bg-red-500 rounded-md hover:bg-red-600">
                        Delete
                    </button>
                </div>
            `;
            historyContainer.appendChild(fileElement);
        }
    };

    // --- NEW DELETE FUNCTION ---
    window.deleteFile = async (fileId) => {
        if (!confirm(`Are you sure you want to permanently delete the file: ${fileId}? This cannot be undone.`)) {
            return;
        }
        
        // The server URL is like 'https://.../webhook', we need to remove '/webhook'
        const baseUrl = serverUrl.replace('/webhook', '');
        const deleteUrl = `${baseUrl}/delete/${fileId}`;

        try {
            const response = await fetch(deleteUrl, {
                method: 'DELETE',
            });

            if (response.ok) {
                alert(`File ${fileId} deleted successfully.`);
                // Reload the file list to update the UI
                fetchFileHistory();
            } else {
                const errorData = await response.json().catch(() => ({}));
                alert(`Failed to delete file: ${errorData.message || response.statusText}`);
            }
        } catch (error) {
            console.error('Error during delete operation:', error);
            alert('An error occurred while communicating with the server.');
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const webhookUrl = localStorage.getItem('webhookUrl');
        if (webhookUrl) {
            serverUrl = webhookUrl;
            fetchFileHistory();
        } else {
             noFilesMessage.classList.remove('hidden');
             noFilesMessage.textContent = 'No webhook URL found. Please go to the sender page and save your settings first.';
        }
    });
</script>

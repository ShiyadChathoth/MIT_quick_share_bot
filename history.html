<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div class="w-full max-w-4xl mx-auto p-4 lg:p-6">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">File History (from Local Archive)</h1>
                <a href="./index.html" class="px-4 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300 focus:outline-none">
                    &larr; Back to Sender
                </a>
            </div>

            <div id="history-container" class="mt-6 space-y-3">
            </div>
            <div id="loading-spinner" class="hidden text-center py-8">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-sm text-gray-500">Fetching history from server...</p>
            </div>
            <p id="no-files-message" class="hidden text-center py-8 text-gray-500">No files found in the local archive folder.</p>
        </div>
    </div>

    <script>
        const historyContainer = document.getElementById('history-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noFilesMessage = document.getElementById('no-files-message');
        let serverUrl = '';

        // NEW HELPER FUNCTION: Convert bytes to readable format
        const formatFileSize = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Function to handle the deletion of a file
        const deleteFile = async (fileId) => {
            if (!confirm(`Are you sure you want to delete the file: ${fileId}? This cannot be undone from the server.`)) {
                return;
            }

            if (!serverUrl) {
                alert('Webhook URL is not set.');
                return;
            }
            
            const baseUrl = serverUrl.replace('/webhook', '');
            
            // Optimistically remove the file from the list
            const fileElement = document.getElementById(`file-${fileId}`);
            if (fileElement) fileElement.classList.add('opacity-50', 'pointer-events-none');


            try {
                // Call the new DELETE endpoint on the server
                const response = await fetch(`${baseUrl}/archive/${encodeURIComponent(fileId)}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error(`Deletion failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Successful deletion, refresh the list
                    console.log(`Successfully deleted: ${fileId}`);
                    fetchFileHistory();
                } else {
                    // Revert the visual change if server reports failure
                    if (fileElement) fileElement.classList.remove('opacity-50', 'pointer-events-none');
                    alert(`Server reported an issue during deletion: ${result.message}`);
                }
            } catch (error) {
                console.error(error);
                // Revert the visual change on network or catch error
                if (fileElement) fileElement.classList.remove('opacity-50', 'pointer-events-none');
                alert(`Failed to delete file. Check console for details.`);
            }
        };


        const fetchFileHistory = async () => {
            if (!serverUrl) {
                // This case is handled in DOMContentLoaded, but good to have a check
                return; 
            }

            historyContainer.innerHTML = '';
            noFilesMessage.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                // The server URL is like 'https://.../webhook', we need to remove '/webhook'
                const baseUrl = serverUrl.replace('/webhook', '');
                const response = await fetch(`${baseUrl}/history`);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const files = await response.json();

                if (files.length === 0) {
                    noFilesMessage.classList.remove('hidden');
                } else {
                    displayFiles(files, baseUrl);
                }
            } catch (error) {
                console.error(error);
                alert(`Failed to fetch history. Check console for details.`);
                noFilesMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        };

        const displayFiles = (files, baseUrl) => {
            for (const file of files) {
                const fileElement = document.createElement('div');
                // Added an ID to the element for easier removal/visual feedback
                fileElement.id = `file-${file.id}`; 
                fileElement.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg';

                const downloadUrl = `${baseUrl}/download/${encodeURIComponent(file.id)}`;
                
                // Formatted file size
                const fileSizeFormatted = formatFileSize(file.size);

                fileElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${file.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            ${fileSizeFormatted} &middot; Created: ${new Date(file.createdTime).toLocaleString()}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <a href="${downloadUrl}" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 text-xs font-medium text-white bg-indigo-500 rounded-md hover:bg-indigo-600 transition-colors">
                            Download
                        </a>
                        <button onclick="deleteFile('${file.id}')" class="px-3 py-1.5 text-xs font-medium text-white bg-red-500 rounded-md hover:bg-red-600 transition-colors">
                            Delete
                        </button>
                    </div>
                `;
                historyContainer.appendChild(fileElement);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const webhookUrl = localStorage.getItem('webhookUrl');
            if (webhookUrl) {
                serverUrl = webhookUrl;
                fetchFileHistory();
            } else {
                loadingSpinner.classList.add('hidden'); // Hide spinner immediately
                noFilesMessage.classList.remove('hidden');
                noFilesMessage.textContent = 'No webhook URL found. Please go to the sender page and save your settings first.';
            }
        });
    </script>
</body>
</html>
